{
  "hash": "abd5fbc0f77ec01b34976d2b4fed72bb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Future'\nsubtitle: 'Welcome to #30DayChartChallenge 2021 day 28'\ndate: '2021-04-28'\nimage: 'day28_future.png'\nimage-alt: ''\ndescription: 'Networks'\noutput: html_document\nexecute: \n   eval: false\n---\n\n\n\n### Tidytuesday week 28 & future day28\n\n\ninspired by http://applied-r.com/plotting-forecast-data-objects-ggplot/\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidytuesdayR)\nlibrary(DataExplorer)\nlibrary(lubridate)\nlibrary(tsibble)\nlibrary(ggrepel)\nlibrary(corrplot)\nlibrary(forecast)\nlibrary(patchwork)\nlibrary(cowplot)\nlibrary(ragg)\nlibrary(RColorBrewer)\n\n\n# load data ###############################\ndepartures <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-27/departures.csv')\n\n# check and wrangling #####################\nhead(departures)\nglimpse(departures)\nprofile_missing(departures)\n\n\ndf <- departures%>%\n  select(2,4,6,7,8,11,12,13)%>%\n  arrange(leftofc)%>%\n  mutate(diff=fyear_gone-fyear)%>%\n  drop_na()%>%\n  select(coname,exec_fullname,fyear,fyear_gone,diff,leftofc,departure_code,ceo_dismissal,max_tenure_ceodb)%>%\n  filter(abs(diff)<6)%>%filter(!diff<0)\n\nrange(df$fyear_gone)\n\n# first plot to see the pattern ###############\n# excluded raws with more than 6 years difference between fyear and fyear_gone\nggplot(df) + \n  geom_point(aes(x=factor(fyear),y=factor(fyear_gone),color=ifelse(abs(diff)<6 ,\"in bound\",\"out of bound\")) )+\n  labs(color=\"\")+\n  theme(axis.text.x = element_text(angle=90))\n  \n# selecting data for main plot ############################\ntot_dismissal <- df %>%\n  mutate(y_month=yearmonth(leftofc),month=month(leftofc))%>%\n  group_by(y_month,month)%>%\n  summarize(tot_dism=sum(ceo_dismissal),tot_posit=sum(max_tenure_ceodb))%>%\n  ungroup()\n\n\n# set the theme and modifications as it is needed --------------------\nlibrary(ggthemes)\n\n# theme for forecast data objects\ntheme.fxdat <- theme_gdocs() +\n  theme(plot.title = element_text(size = 25,color=\"grey45\"),\n        plot.subtitle = element_text(size = 11),\n        plot.caption = element_text(size = 9, hjust = 0, vjust = 0, colour = \"grey50\"),\n        axis.title.y = element_text(face = \"bold\", color = \"gray30\"),\n        axis.title.x = element_text(face = \"bold\", color = \"gray30\", vjust = -1),\n        axis.text.x = element_text(angle=90),\n        panel.background = element_rect(fill = \"grey95\", colour = \"grey75\"),\n        panel.border = element_rect(colour = \"grey75\"),\n        panel.grid.major.y = element_line(colour = \"white\"),\n        panel.grid.minor.y = element_line(colour = \"white\", linetype = \"dotted\"),\n        panel.grid.major.x = element_line(colour = \"white\"),\n        panel.grid.minor.x = element_line(colour = \"white\", linetype = \"dotted\"),\n        strip.background = element_rect(size = 1, fill = \"white\", colour = \"grey75\"),\n        strip.text.y = element_text(face = \"bold\"),\n        axis.line = element_line(colour = \"grey75\"),\n        legend.position = \"top\",\n        legend.box = \"horizontal\",\n        legend.box.just = \"bottom\")\n\ntot_dismissal$y_month[80]\ntot_dismissal$tot_dism+rnorm(tot_dismissal$tot_dism)[1]\n\n# plotting ########################################\nlibrary(zoo)\nset.seed(345)\nplot1 <- ggplot(tot_dismissal,aes(x=y_month,y=tot_dism+rnorm(tot_dism))) + \n  geom_point(aes(color=\"Number of dismissal\"),fill=\"black\")+\n  geom_line(aes(color=\"Dismissal Trend\"),size=0.2) +\n  geom_smooth(aes(color=\"Smoothed conditional means\"))+\n  geom_line(aes(y_month,rollmedian(tot_dism, k = 15, fill = NA, align = \"center\"),color=\"Rolling median\"),size=0.8)+\n  labs(x=\"Time(Year-Month)\",\n       y=\"Normalized total n. of dismissal\",\n       title=\"33 Years trend CEO Departures\",\n       subtitle=\"1988 - 2021\\n Rolling median, smooth variation line and trend\",\n       caption=\"\",\n       color=\"\"\n       )+\n  scale_color_brewer(palette = \"Dark2\")+\n  theme.fxdat \n\n\n\n# future ----------------------------\nx<-tot_dismissal$tot_dism\n\n# create time series data object (ts) using tot_dism\nres.gen <- ts(x, frequency = 12, start = c(1992, 6))\n\nxx<-tot_dismissal%>%\n  pivot_wider(names_from=\"month\",values_from=\"tot_dism\",values_fill=0)%>%select(-tot_posit,-y_month)\n\n########################\nfit.y <- tslm(res.gen ~ trend + season)\nfx.y <- forecast(fit.y, h = 17, level = c(80, 95, 99))\n\n\nsource(\"plot_fx.R\")\n\nplot2 <- plot_fx(fx.y,\n        PI = TRUE,\n        line.cols = NA,\n        shade.cols = NA,\n        show.gap = TRUE,\n        date.breaks = \"15 months\",\n        date.format = \"%b-%y\",\n        main.title = \"CEO Departures forecast\",\n        sub.title = \"Transformed 33 years trend in Linear trend with seasonal dummy variables\",\n        caption = \"Viz. @fgazzelloni | DataSource: Gentry et al. & investors.com | TidyTuesday week18\",\n        x.title = \"CEO Departures by Year and Month\",\n        y.title = \"Total numbers of CEO Departures\")\n\n\nfinal<-plot1+plot2\n\n\n\n####### SAVING ######################################\nragg::agg_png(here::here(\"w18\", \"tidytuesday_Departures.png\"),\n              res = 320, width = 14, height = 8, units = \"in\")\nfinal\n\ndev.off()\n\n\n\n#### ATTACHING LOGO ############################ \nlibrary(ggimage)\nlibrary(magick)\n\n\ntidy_logo<-image_read(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/static/plot_logo.png\") %>%\n  image_resize(\"300x300\")\n\n\nfinal_plot <- image_read(\"W18/tidytuesday_Departures.png\")\n\nattached_logo <- image_composite(final_plot, tidy_logo,\n                                 operator=\"atop\",\n                                 gravity=\"northeast\") # tell R where to put the logo\n\n\nimage_write(attached_logo, path = \"tidytuesday_Departures.png\", format = \"png\") # save final plot\n```\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
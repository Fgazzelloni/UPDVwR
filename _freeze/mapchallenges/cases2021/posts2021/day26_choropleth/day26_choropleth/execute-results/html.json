{
  "hash": "9dcb1669a2de1ea2f13c7224ba3ef1b8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Choropleth Map'\nsubtitle: 'Welcome to #30DayMapChallenge 2021 day 26'\ndate: '2021-11-26'\nimage: 'https://raw.githubusercontent.com/Fgazzelloni/30DayMapChallenge/master/2021/day26_choropleth/choropleth.png'\nimage-alt: ''\ndescription: ''\noutput: html_document\nexecute: \n   eval: false\n---\n\n\n\n# Overview\n\nMap of the `World Population density` per sq mile and Number of vulnerable people in the area. `WorldBank Datacatalog`.\n\n\n\n### How to read a .shp file in r:\n\n- https://datacarpentry.org/r-raster-vector-geospatial/06-vector-open-shapefile-in-r/\n\n\n### Inspiration:\n\n- https://gist.github.com/leeolney3/8f26d720c1884fccab282bad23dc6038\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list=ls())\n\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(biscale)\nlibrary(cowplot)\n\nlibrary(sysfonts)\nlibrary(showtext)\nshowtext_opts(dpi = 320)\nfont_add_google(\"Covered By Your Grace\", \"grace\")\nshowtext_auto()\nf1= \"grace\"\nf2= \"grace\"\n\n######################################\n# datasource: https://datacatalog.worldbank.org/search/dataset/0042041/International-Poverty-Line---Subnational-Poverty\n\n\n\n# 1. poverty data\n# https://datacatalog.worldbank.org/search/dataset/0042041/International-Poverty-Line---Subnational-Poverty\n# for example poor190_ln means Poverty rate at $1.9\nlibrary(readxl)\npoverty_data <- read_excel(\"day26_choropleth/data/global-subnational-poverty-atlas-gsap-data.xlsx\")\npoverty_data%>%head\n\n# 2. population data\nlibrary(readr)\nPopulation_EstimatesData <- read_csv(\"day26_choropleth/data/Population-EstimatesData.csv\")\nPopulation_EstimatesData%>%head\n\n\n\n# Join the sets\nmy_df <- poverty_data%>%\n  select(region,code,contains(\"poor\"), median_ln,mean_ln) %>%\n  pivot_longer(cols=starts_with(\"poor\"),names_to=\"poor_cat\",values_to=\"poor_rate\") %>%\n  pivot_longer(cols=starts_with(\"npoor\"),names_to=\"npoor_cat\",values_to=\"poor_numb\")\n\n\n\nmy_df2 <- Population_EstimatesData%>%\n  janitor::clean_names()%>%\n  select(country_name,country_code,starts_with(\"x\"))%>%\n  pivot_longer(cols=contains(\"x\"),names_to=\"year\",values_to=\"pop\") %>%\n  mutate(year=gsub(\"x\",\"\",year))%>%\n  filter(year>2000,year<2021) %>%\n  group_by(country_name,country_code,year)\n\n\nmy_df2$pop[is.na(my_df2$pop)]<-0\n\n\nmy_df3 <- my_df2%>%\n  group_by(country_name,country_code,year)%>%\n  summarize(tot_pop=sum(pop),.groups=\"drop\")%>%\n  ungroup()\n\n\n# 3. map\n# load data\nlibrary(tmap)\ndata(\"World\")\n\nmy_df4 <- my_df3%>%\n  left_join(my_df,by=c(\"country_code\"=\"code\"))%>%\n  left_join(World %>%select(country_code=iso_a3,geometry),by=\"country_code\")\n\n\n\nmy_df5 = bi_class(my_df4,\n                  x=tot_pop,\n                  y=poor_numb,\n                  style = \"quantile\", dim = 3)\n\n\nmap = ggplot() +\n  geom_sf(data=my_df5,\n          aes(fill=bi_class, geometry=geometry),\n          size=.1,show.legend=F, color=\"white\") +\n  bi_scale_fill(pal=\"GrPink\", dim=3) +\n  coord_sf(expand=F) +\n  theme_void() +\n  theme(plot.background = element_rect(fill=\"#212A2E\", color=NA))\n\n# save map plot\nragg::agg_png(here::here(\"R_general_resources/30DayMapChallenge/day26_choropleth/map.png\"),\n              res = 320, width = 12, height = 8, units = \"in\")\nmap\ndev.off()\n\n############################## ############################## ##############################\n\nlegend = bi_legend(pal = \"GrPink\",\n                   dim = 3,\n                   ylab = \"Vunerables in the area\",\n                   xlab = \"Population density\",\n                   size = 2.5) +\n  theme(panel.border = element_blank(),\n        axis.text = element_blank(),\n        axis.title.x = element_text(size = 16, family=f1, hjust=0,\n                                    color = \"white\", margin=margin(t=-5)),\n        axis.title.y = element_text(size = 16, family=f1, hjust=0,\n                                    color = \"white\", margin=margin(r=-5)),\n        legend.text = element_text(size = 14),\n        panel.background = element_blank(),\n        panel.grid.major=element_blank(),\n        plot.background = element_blank(),\n        legend.text.align = 0)\n\n\n\nlibrary(cowplot)\np1 = ggdraw() +\n  draw_image(image = here::here(\"day26_choropleth/data/map.png\"),\n             x=0,y=0,scale=2) +\n  draw_plot(legend, x=0.75, y=0.05, width= 0.3, height= 0.3) +\n  draw_line(x = c(-0.1, 0.36),y = c(0.95, 0.95),color = \"#212A2E\", size = 30) +\n  draw_label(\"World focus on:\", x=0.02, y=0.92,\n             fontfamily = f2, hjust=0, vjust=0,size=52, color=\"white\", fontface=\"bold\") +\n  draw_label(\"Population density per sq mile\\n\\nand\\n\\nNumber of vulnerable people\\n\\nin the area\",\n             x=0.13, y=0.55,\n             fontfamily = f2, hjust=0, vjust=0, size=22, color=\"white\",\n             lineheight = 0.4) +\n  draw_label(\"Datasource: datacatalog.worldbank.org | #30DayMapChallenge choropleth\\nGraphic: Federica Gazzelloni \",\n             x=0.5, y=0.05, size = 18, fontfamily = f2, color=\"white\") +\n  theme(plot.background = element_rect(fill=\"#212A2E\", color=NA),\n        panel.background = element_rect(fill=\"#212A2E\", color=NA),\n        plot.margin=margin(.5,.5,.5,.5, unit=\"cm\"))\n\n# save final plot\nragg::agg_png(here::here(\"day26_choropleth/choropleth.png\"),\n              res = 320, width = 12, height = 8, units = \"in\")\np1\ndev.off()\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "d9e804907ca1636168c69ad1208be1ec",
  "result": {
    "markdown": "---\ntitle: 'Bee Colony losses'\nsubtitle: 'Welcome to #TidyTuesday 2022 day 2'\ndate: '2022-01-11'\nimage: 'https://raw.githubusercontent.com/Fgazzelloni/TidyTuesday/main/data/2022/w2_bees/w2_bees.png'\nimage-alt: ''\ndescription: 'Networks'\noutput: html_document\nexecute: \n   eval: false\n---\n\n::: {.cell paged.print='false'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncolony <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/colony.csv')\nstressor <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/stressor.csv')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- colony %>%\n  full_join(stressor,by=c(\"year\",\"months\",\"state\"))\n\ndf<-df%>%filter(!is.na(colony_n))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmap <- ggplot2::map_data(\"state\")\nmap\n\nlibrary(maps)\ndata(state.fips)\nabb<-state.fips%>%select(polyname,abb)\n\nmap <-map%>%left_join(abb,by=c(\"region\"=\"polyname\"))%>%\n  mutate(abb=case_when(region==\"massachusetts\"~\"MA\",\n                       region==\"michigan\"~\"MI\",\n                       region==\"new york\"~\"NY\",\n                       region==\"north carolina\"~\"NC\",\n                       region==\"virginia\"~\"VA\",\n                       region==\"washington\"~\"WA\",\n                       TRUE ~ abb))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(extrafont)\nlibrary(showtext)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi=320)\nlibrary(sysfonts)\nfont_families_google()\nfont_add_google(name=\"Baskervville\",family=\"bees1\")\n\n\n#font_add_google(name =\"Black Han Sans\" ,family = \"my_font\")\n#font_add_google(name =\"Odibee Sans\" ,family = \"my_font1\")\n\nfamily = \"bees1\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_df <- df%>% \n  count(state,year,colony_lost_pct,stressor,stress_pct)%>%\n  filter(year==c(2015,2020))%>%\n  mutate(state=tolower(state))%>%\n  filter(!state%in%c(\"hawaii\",\"other states\",\"united states\"))%>%\n  filter(!is.na(stress_pct))%>%\n  select(-n) %>% # \n  pivot_wider(names_from = year,values_from=stress_pct,\n              values_fill = 0.00001, values_fn={mean}) %>%\n  mutate(stress_pct_diff=round(((`2020`/`2015`) *100)-100))\n  \ntidy_df_geo <- tidy_df%>% left_join(map,by=c(\"state\"=\"region\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbees_map_df <- tidy_df_geo%>%\n  group_by(state)%>%\n  mutate(lat2=median(range(lat)),\n         long2=median(range(long)))%>% # this is to positioning the numbers \n  ungroup()%>%\n  count(state,abb,long2,lat2,group,stress_pct_diff)%>%\n  group_by(state) %>%\n  mutate(m_stress_pct_diff=round(mean(stress_pct_diff)/10000000,2))%>%\n  ungroup()\n \nbees_map <-ggplot()+\n  geom_polygon(data=tidy_df_geo,\n               mapping=aes(x=long, y=lat, group = group),\n               alpha=0.2,fill=\"gold\",show.legend = F)+\n    \n  stat_summary_hex(data=tidy_df_geo,aes(x=long,y=lat,z=group),\n                   fill=\"orange\",color=\"gold\") +\n  geom_point(data=bees_map_df,mapping = aes(x=long2, y=lat2, group = group,\n                           size=m_stress_pct_diff),\n             shape=21,stroke=0.1,color=\"#299E50\") +\n  geom_text(data=bees_map_df,\n            mapping = aes(x=long2, y=lat2, group = group,\n                           label=abb),size=3,color=\"grey25\") +\n  scale_size_identity(guide=\"legend\")+\n  guides(size = guide_legend(override.aes = list(color = \"grey25\",stroke=1)))+\n  labs(title=\"US Bees colony lost and stressor\",\n       subtitle=\"(%) difference 2015 - 2020\",\n       size=\"AVG Stressor (%)\") +\n  ggthemes::theme_map()+\n  theme(text = element_text(family=family,face=\"bold\"),\n        legend.background = element_blank(),\n        legend.box.background = element_blank(),\n        legend.position = c(0.1,-0.15),\n        legend.key = element_rect(fill=\"orange\",color=\"gold\",size=2),\n        legend.text = element_blank(),\n        plot.background = element_blank(),\n        plot.title = element_text(size=25,face=\"bold\"),\n        plot.subtitle =  element_text(size=15),\n        panel.background = element_blank())\n\n# bees_map\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggimage)\n\nbees_fly <-df%>%\n  filter(year%in%c(2015,2020))%>%\n  select(state,stressor,stress_pct,colony_lost,year) %>% \n  mutate(stress_pct=ifelse(is.na(stress_pct),0,stress_pct)) %>% \n  #group_by(state)%>%summarize(mean=mean(stress_pct))\n  pivot_wider(names_from = year,values_from=colony_lost,\n              values_fn={mean},values_fill=0) %>%\n  mutate(diff_colony_lost=round(`2020`-`2015`)) %>%\n  #select(-`2015`,-`2020`)%>%\n  mutate(stressor=case_when(stressor==\"Other pests/parasites\"~\"Other\",\n                            stressor==\"Unknown\"~\"Other\",\n                            TRUE~stressor)) %>%\n  group_by(stressor) %>%\n  mutate(m_colony_lost=mean(diff_colony_lost))%>%\n  ungroup()%>%\n  #mutate(img = \"<img src='w2_bees/bees.png' width='12'/>\") %>%\n  mutate(img = \"bees.png\",\n         img=as.factor(img)) %>%as.data.frame()\n\n\npct_decr_lost<- bees_fly %>%\n  count(stressor,m_colony_lost=round(m_colony_lost))%>%\n  mutate(tot_loss=round(m_colony_lost*n),\n         pct=paste0(round(tot_loss/sum(tot_loss)*100),\"%\"))\n\n\nrange(bees_fly$m_colony_lost)\n\n\nbees_fly_plot<-bees_fly%>%\n  left_join(select(pct_decr_lost,stressor,pct),by=\"stressor\")%>%\n  ggplot(aes(x=fct_reorder(stressor,m_colony_lost),y=m_colony_lost))+\n  geom_line(orientation = \"x\",aes(group=1))+\n  ggimage::geom_image(aes(image=img), size=.1) +\n  geom_vline(aes(xintercept=fct_reorder(stressor,-m_colony_lost)),alpha=0.2,color=\"gold\")+\n  geom_text(aes(label=stressor),vjust=-2.5,hjust=0.65)+\n  geom_text(aes(label=pct),vjust=2.5)+\n  expand_limits(x=0,y=c(-1300 , -900))+\n  scale_y_reverse()+ #limits=rev)+\n  scale_x_discrete(limits=rev)+ #limits=rev)+\n  labs(caption=\"Datasource: USDA | DataViz: Federica Gazzelloni\")+\n  theme_void()+\n  theme(text = element_text(family=family,face=\"bold\"),\n        plot.caption=element_text(size=11,face=\"bold\"))\n\n\n# bees_fly_plot\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cowplot)\n\nfinal <- ggdraw()+\n  draw_plot(bees_fly_plot,scale = 0.6,x=0.19,y=-0.13)+\n  draw_plot(bees_map,scale = 0.8,x=-0.1,y=0.1)+\n  draw_image(\"https://d3l4q0oih2c6yv.cloudfront.net/assets/esmis/cornell_seal_simple_b31b1b-54caf4668562db6b35fe259a44a4f9dc5db28a966230652ae2b175edcb9d56f0.svg\",\n             scale=0.1,x=0.45,y=0.43)+\n  draw_image(\"usda_logo.png\",\n             scale = 0.1, x=0.35,y=0.43)+\n  draw_image(\"bee_informed.png\",scale = 0.09,x=-0.37,y=-0.315)+\n  draw_image(\"bee_informed.png\",scale = 0.055,x=-0.37,y=-0.12)+\n  draw_label(\"The Stressors are the causes for bees colony loss\\n the (%) difference 2015-2020 shows some states are more affected then othes by\\n stressors.\",\n             x=0.38,y=0.07,fontfamily = family,size=11)+\n  draw_label(\"Low\",x=0.2,y=0.3,fontfamily = family)+\n  draw_label(\"High\",x=0.2,y=0.2,fontfamily = family)+\n  draw_label(\"Includes unknwon and parasites\",x=0.77,y=0.5,\n             fontfamily = family,size=11)+\n  draw_line(x=c(0.78,0.8),y=c(0.44,0.49),color=\"orange\")+\n  draw_label(\"Percentange of the stressor affecting the colonies\",x=0.8,y=0.2,fontfamily = family,size=10)+\n  draw_line(x=c(0.8,0.78),y=c(0.21,0.31),color=\"orange\")+\n  draw_label(\"The least contributing to bees loss\",x=0.85,y=0.66,\n             size=11,fontfamily = family)+\n  draw_line(x=c(0.89,0.9),y=c(0.56,0.65),color=\"orange\")+\n  draw_label(\"Leading parasite affecting \\nbees colony\\n named Varroa destructor\",x=0.38,y=0.2,size=11,fontfamily = family)+\n  draw_line(x=c(0.42,0.5),y=c(0.18,0.2),color=\"orange\")+\n  draw_image(\"bee_flying.png\",scale = 0.55,x=0.2,y=0.3)\n    \n    \n#final\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\n  paste0(\"bees_\", format(Sys.time(), \"%d%m%Y\"), \".png\"),\n   plot =final,\n  bg=\"white\",\n  dpi = 320,\n  width = 11,\n  height = 6\n)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
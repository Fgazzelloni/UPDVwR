{
  "hash": "aaf7018e2ac0a3a62593e8c0964ce67e",
  "result": {
    "markdown": "---\ntitle: 'NBER Papers'\nsubtitle: 'Welcome to TidyTuesday 2021 week 40'\ndate: '2021-09-28'\nimage: 'w40_NBER_Papers.png'\nimage-alt: ''\ndescription: 'Networks'\noutput: html_document\nexecute: \n   eval: false\n---\n\n\n# Title: \"TidyTuesday Week 40 - NBER Programs Category\"\n# Author: \"Federica Gazzelloni\"\n# Date: \"9/30/2021\"\n# Datasource: https://www.nber.org/\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#----Libraries----\n# Load the libraries\nlibrary(tidyverse)\nlibrary(tidymodels)\ntidymodels_prefer()\n#library(nberwp)\nlibrary(extrafont)\n#fonts()\nlibrary(RColorBrewer)\nlibrary(patchwork)\n\n#----Load Data----\n# TidyTuesday week40 datasets\npapers <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-28/papers.csv')\nauthors <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-28/authors.csv')\nprograms <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-28/programs.csv')\npaper_authors <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-28/paper_authors.csv')\npaper_programs <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-28/paper_programs.csv')\n\n#----Data Wrangling----\n# Joining sets\nauthors <- authors %>% select(author,name)\nprograms <- programs %>% drop_na()\n\ndf <- papers %>%  #count(paper)                # 29434     4\n  inner_join(paper_authors, by =\"paper\") %>%   # 67090     2\n  full_join(paper_programs, by = \"paper\") %>%  # 53996     2\n  inner_join(authors, by = \"author\") %>%       # 15437     2\n  full_join(programs, by = \"program\") %>%      #    20     3\n  drop_na() \n\n# Make a dataframe with programs category and proportions\ndf_cat <- df %>%\n  count(program_desc,program_category,sort=T) %>%\n  mutate(prop = n/sum(n)*100) %>%\n  pivot_wider(names_from = program_category, values_from = program_desc)\n\ndf_cat\n\n# Set the data ready to use in the plot function\n\ndf_plot <- df %>% count(year,program_category,program_desc) \n\nplot_fin_df <- df_plot %>% filter(program_category == \"Finance\")\nplot_mic_df <- df_plot %>% filter(program_category == \"Micro\")\nplot_mac_df <- df_plot %>% filter(program_category == \"Macro/International\")\n\n#----Plot features----\n# Set all the specifications for the plot function to build\n# Make three tibbles as to be used in the legends\nleg_fin <- tibble(\"Finance\"=paste(df_cat$Finance,\"-\",round(df_cat$prop,2),\"%\"))%>%filter(!str_detect(Finance,\"NA\"))\nleg_mic <- tibble(\"Micro\"=paste(df_cat$Micro, \"-\",round(df_cat$prop,2),\"%\"))%>%filter(!str_detect(Micro,\"NA\"))\nleg_mac <- tibble(\"Macro/International\"=paste(df_cat$`Macro/International`,\"-\",round(df_cat$prop,2),\"%\"))%>%filter(!str_detect(`Macro/International`,\"NA\"))\n\nleg_fin;leg_mic;leg_mac\n\n#Set the `color` option for the plot function\nrequire(RColorBrewer)\n# color\ncut_colors1 <- setNames(brewer.pal(2, \"Set1\"), levels(plot_fin_df$program_desc))\ncut_colors2 <- setNames(brewer.pal(4, \"Paired\"), levels(plot_mac_df$program_desc))\ncut_colors3 <- setNames(c(brewer.pal(name = \"Set3\", n = 12), brewer.pal(name = \"Pastel1\", n = 2)), levels(plot_mic_df$program_desc))\n\n# Unlist legends-dataframe to be used in the legends\n# leg_lab\nleg_fin <- unlist(leg_fin$Finance)\nleg_mac <- unlist(leg_mac$`Macro/International`)\nleg_mic <- unlist(leg_mic$Micro)\n\n# leg_pos  \nset1 = c(0.73,0.78)\nset2 = c(0.7,0.8)\nset3 = c(0.55,0.8)\n\n#----ggcombo-------\n# Make a `ggcombo()` plot building a function for plotting the program categories\n\nggcombo <- function(data1,data2,data3){\n  \n  ggbar_cat <- function(data,leg_pos,leg_lab,leg_col,color){\n    \n    data %>%\n      ggplot(aes(x = year,y = n,group = program_desc,fill = program_desc)) +\n      geom_col() +\n      facet_wrap(vars(program_category), ncol = 1, strip.position = \"right\") +\n      \n      scale_fill_manual(values = color, label = leg_lab, name = paste(data[[1,2]],\"category Impact proportion\")) +\n      scale_y_continuous(position = \"right\") +\n      guides(fill = guide_legend(ncol = leg_col,title.position = \"top\", title.hjust = 0.5)) +\n      ggthemes::theme_fivethirtyeight() +\n      theme(text = element_text(family = \"Roboto Condensed\"),\n            axis.text.x = element_text(face = \"bold\",size = 8),\n            axis.text.y = element_text(),\n            legend.text = element_text(size = 8),\n            legend.key.size = unit(0.3, 'cm'),\n            legend.title = element_text(face = \"bold\"),\n            \n            legend.position = leg_pos,\n            legend.background = element_blank(),\n            strip.placement = \"outside\",\n            strip.text = element_text(face = \"bold\",size = 14))\n  }\n  \n  plot_fin <- ggbar_cat(data1,set1,leg_fin,1,cut_colors1)\n  plot_mac <- ggbar_cat(data2,set2,leg_mac,1,cut_colors2)\n  plot_mic <- ggbar_cat(data3,set3,leg_mic,2,cut_colors3)\n  \n  require(patchwork)\n  plot_fin <- plot_fin +\n    labs(title = \"\\n\",subtitle = \"\\n\")\n  \n  plot_fin/plot_mac/plot_mic\n}\n\n\n# Assign a name to the ggcombo \nplot <- ggcombo(plot_fin_df,plot_mac_df,plot_mic_df)\n\n\n#----Pie chart----\n# Make a pie_chart logo\npie_colors <- brewer.pal(name = \"Set2\", n = 3)\n\npie_df <- df %>%\n  count(program_desc,program_category,sort = T) %>%\n  mutate(prop = n/sum(n)*100)\n\npar_prop <- pie_df %>%\n  group_by(program_category) %>%\n  summarize(par_prop = round(sum(prop),0))\n\npie_plot <- pie_df %>%\n  left_join(par_prop,by = \"program_category\") %>%\n  ggplot(aes(x = \"\", y = prop, fill = program_category)) +\n  geom_col(width = 1, stat = \"identity\") +\n  scale_fill_manual(values = pie_colors,name = \"NBER Programs Category\") +\n  guides(fill = guide_legend(ncol = 1,title.position = \"top\", title.hjust = 0.5)) +\n  ggthemes::theme_fivethirtyeight() +\n  theme(text = element_text(family = \"Roboto Condensed\"),\n        panel.grid = element_blank(),\n        panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        axis.text = element_blank(),\n        legend.text = element_text(size = 14),\n        legend.key.size = unit(0.5, 'cm'),\n        legend.title = element_text(face = \"bold\",size = 16),\n        legend.position = \"none\",#c(0.21,0.9),\n        legend.background = element_blank(),\n        strip.placement = \"outside\") +\n  annotate(geom = \"text\", label = \"Micro\\n62%\", x = 1.1, y = 20, colour = \"grey20\", size = 14, family = \"Roboto Condensed\") +\n  annotate(geom = \"text\", label = \"Macro\\n28%\", x = 1.2, y = 80, colour = \"grey20\",size = 14, family = \"Roboto Condensed\") +\n  annotate(geom = \"text\", label = \"Finance\\n10%\", x = 1.2, y = 95, colour = \"grey20\", size = 11,family = \"Roboto Condensed\") +\n  coord_polar(\"y\", start = 0) \n\n# save the pie_chart_logo\nragg::agg_png(here::here(\"w40/w40_pie_ep.png\"),\n              res = 320, width = 8, height = 8, units = \"in\")\npie_plot\ndev.off()  \n\n#----Annotations----\n# Annotate the figure first with adding top and bottom information to have it framed with `ggarrange()`\nlibrary(ggimage)\nlibrary(magick)\nlibrary(cowplot)\nlibrary(ggpubr)\n\ngraphics <- ggarrange(plot)\n\nfinal_plot <- annotate_figure(graphics,\n                              top = text_grob(\"NBER National Bureau of Economic Research\",\n                                              color = c(\"grey28\"), face = \"bold\", size = 34,\n                                              family = \"Roboto Condensed\"),\n                              bottom = text_grob(\"Infographics Federica Gazzelloni DataSource: NBER - TidyTuesday week40\\n\",\n                                                 color = \"grey28\",family = \"Roboto Condensed\",\n                                                 hjust = 0.5, x = 0.58, face = \"bold.italic\", size = 16)\n)\n\n\n# Finally, add some other extra information with more annotations\nlibrary(gridExtra)\n\nfinal_plot <-\n  final_plot +\n  \n  annotate(geom = 'segment',y = 0.87, yend = 0.93, x = 0.9,xend = 0.9, color = \"#1E90FF\", size = 10) +\n  \n  annotate(geom = \"text\", label = \"All three Program Categories reached the top level in 2020 with \n           the highest number of paper publications due to Covid19\",\n           x = 0.58, y = 0.90,colour = \"grey20\",size = 6,family = \"Roboto Condensed\",fontface = \"bold\") +\n  \n  annotate(geom = \"text\", label = \"Finance topic started in 1978 \n           but with lack of success since late 1990 \n           when started its continuous growth\",\n           x = 0.25, y = 0.7,colour = \"grey20\",size = 5,family = \"Roboto Condensed\") +\n  \n  annotate(geom = \"text\", label = \"Macro/International topic started in 1975 \n           reaching the highest level among the other \n           categories, after the first decrease in early 1990 decade, \n           most probably for the increased interest in other topics, \n           maintained a steady growth along the years\",\n           x = 0.28, y = 0.5,colour = \"grey20\",size = 4,family = \"Roboto Condensed\") +\n  \n  annotate(geom = \"text\", label = \"Micro topic is the most varied one, \n           and maintained little but steady increase \n           along the whole period\",\n           x = 0.24, y = 0.15,colour = \"grey20\",size = 5,family = \"Roboto Condensed\") \n\n#----Logos----\n# add the logos \nimg_pie <- image_read(here::here(\"w40_NBER_papers/pie_ep.png\"))\nimglogo <- image_read(here::here(\"w40_NBER_papers/nber-logo.png\"))\n\nfinal <- ggdraw() +\n  draw_plot(final_plot) +\n  draw_image(img_pie, x = 0.05, y = 0.35,width = 0.22) +\n  draw_image(imglogo, x = 0.01, y = -0.48,width = 0.2)\n\n\n#----Save final plot----\nragg::agg_png(here::here(\"w40_NBER_papers/w40_NBER_papers.png\"),\n              res = 320, width = 10, height = 12, units = \"in\")\nfinal\ndev.off()\n\n#----Tidytuesday logo----\n# read the image, attach the Tidytuesday logo and save it\ntidy_logo <- image_read(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/static/plot_logo.png\") %>%\n  image_resize(\"300x300\")\n\ntidy_final <- image_read(here::here(\"w40_NBER_papers/w40_NBER_papers.png\"))\nattached_logo <- image_composite(tidy_final, tidy_logo,\n                                 operator = \"atop\",\n                                 gravity = \"southeast\")\n\nimage_write(attached_logo, path = \"w40_NBER_papers.png\", format = \"png\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}